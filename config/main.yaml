# config/main.yaml

# ==============================================================================
# 1. 路径配置 (Paths)
# 对应原 config/paths.yaml 以及 model_config.yaml 中的路径定义
# ==============================================================================
paths:
  project_root: "."
  data_root: "data"
  data_raw: "data/raw"              # 原始行情数据
  data_cleaned: "data/raw_cleaned"  # 清洗后的原始数据
  data_processed: "data/processed"  # 处理后的特征 & 标签
  data_meta: "data/meta"            # 元数据（行业/名称/交易日历等）
  models: "data/models"             # 模型保存路径
  logs: "logs"                      # 日志路径

  # 分析模块输出路径
  figures: "figures"             # 存放图片 (png/jpg)
  reports: "reports"             # 存放分析报告 (csv/html)

  # 注意：原 model_config.yaml 中使用了 G 盘绝对路径。
  # 建议代码中直接使用上述相对路径拼接。如果必须使用绝对路径，请在此处修改。
  # processed_absolute: "g:/理财/Quant_A_Share_V2.0/data/processed"


# ==============================================================================
# 2. 数据源与下载配置 (Data Source)

# ==============================================================================
data:
  source: "baostock"
  start_date: "2010-01-01"
  end_date: "2025-12-31"   # 可设置为 "auto" 以自动使用当前日期

  # 增量更新时的配置
  update:
    tail_days: 15

  # 股票池下载范围 (Primary Stock Pool)
  stock_pool:
    include_sh: true
    include_sz: true
    include_kcb: false     # 科创板
    include_cyb: false     # 创业板
    include_bj: false      # 北交所
    exclude_st: true
    only_tradable: true


# ==============================================================================
# 3. 预处理与特征工程 (Preprocessing)

# ==============================================================================
preprocessing:
  # 基础设置
  # (代码中建议直接读取 paths.data_processed，此处保留作为备用或特定子目录)
  output_dir: "data/processed"

  # 股票池二次筛选逻辑 (Universe & Filtering)
  universe:
    type: "all"            # "all" => 全市场股票 / hs300 / zz500
    custom_list: []        # 若 type = "custom"，这里写股票代码列表

  # 选股/过滤条件 (Filter Rules)
  filter:
# --- 1. 价格限制 ---
    max_price: 25              # (旧) 允许的最高股价
    min_price: 1.5             # (新) 最低股价 (剔除低价垃圾股)

    # --- 2. 成交量/额限制 (兼容旧命名) ---
    min_turnover: 10000000     # (旧) 日均成交额下限 (这里保留旧名字，对应 Amount)
    min_volume: 30000         # (旧) 最低成交量

    # --- 3. 流动性/换手率 (新增) ---
    min_turnover_rate: 0.5     # (新) 日均换手率下限 (单位 %，对应真正的 Turnover Rate)

    # --- 4. 市值限制 (截图中的配置) ---
    min_mcap: 2000000000       # (旧) 最小流通市值 (70亿)
    max_mcap: 5000000000000     # (旧) 最大流通市值 (5000亿)

    # --- 5. 其他 ---
    exclude_st: true           # 排除 ST
    exclude_new: true          # 排除新股
    min_days_listed: 60        # 上市至少多少天



  # 特征工程配置 (Feature Engineering)
  features:
    enable_basic: true     # ret_1 / log_ret / 振幅等
    enable_ma: true
    enable_macd: true
    enable_rsi: true
    enable_kdj: true
    enable_boll: true
    enable_volume: true

    # === [新增] 新因子开关 ===
    enable_slope: true       # 启用斜率/变化率因子 (如 RSI_slope)
    enable_volatility: true  # 启用波动率因子 (如 ATR, Std)
    enable_pv_corr: true     # 启用量价相关性因子

    # 特征参数
    ma_windows: [5, 10, 20, 60]
    rsi_window: 14
    kdj_window: 9
    boll_window: 20
    boll_std: 2
    # multi_scale_features: false

    # [新增] 波动率计算窗口
    vol_window: 20

  # 标签生成配置 (Label Generation)
  labels:
    target_type: "regression"
    return_mode: "excess_index" # 收益模式
    horizon: 4
    # 标签平滑窗口
    # 设为 3 意味着取 [T-1, T, T+1] 三天的均值作为退出价格
    # 设为 1 则不平滑（原逻辑）
    smooth_window: 3


    # === [新增] 标签清洗配置 ===
    # 针对上一轮分析发现的 max=4.61 的异常值，进行 1%~99% 去极值
    enable_winsorize: true
    winsorize_limits: [0.01, 0.99] # 截断上下 1% 的极端值

    # === 新增：标签生成方法 ===
    # 价格设置
    use_vwap: true       # 开启 VWAP，代码中会将其用于 Entry
    
    method: "fixed_time"
    
    # === 新增：三相屏障参数 ===
    triple_barrier:
      pt: 0.10    # Profit Taking (止盈阈值, e.g. 10%)
      sl: 0.05    # Stop Loss (止损阈值, e.g. 5%)

    use_vwap: true         # 开启 VWAP 计价
    filter_limit: true     # 开启一字板过滤
    index_code: "000300.SH"
    index_dir: "index"
    
    binary_threshold: 0.0
    multiclass:
      up: 0.01
      down: -0.01
    quantile_bins: [0.2, 0.8]



  # 数据存储批处理 (Batch Processing)
  batch:
    save_each: true        # 保存每只股票的 parquet 文件
    concat_all: true       # 是否自动合并为一个大表
    concat_file: "all_stocks.parquet" # 这里仅指定文件名，路径由 paths 决定

  # [新增] 数据质量清洗阈值
  quality:
    max_suspension_rate: 0.3   # 停牌天数超过 10% 则剔除
    min_avg_turnover: 0      # 日均换手率低于 1% 则剔除 (僵尸股)

# [新增] 特征中性化配置
  neutralization:
    enable: true
    # 风险因子：你想剔除的影响因素（通常是市值、行业哑变量）
    risk_factors: 
      - "feat_mcap_log"
    # 目标特征：'all' 表示除了风险因子外的所有 feat_ 开头的特征
    features_to_neutralize: "all" 
    # 并行加速：如果数据量大，开启并行
    n_jobs: -1
# ==============================================================================
# 4. 模型训练配置 (Model)

# ==============================================================================
model:
  version: "auto"          # 自动检测最新版本
  label_col: "label"
  
  # 数据集划分
  train_val_split_date: "2023-01-01"
  train_ratio: 0.8

  # XGBoost 参数 (优化后 - 2025-12-15)
  # 优化要点：降低学习率、加强正则化、减小复杂度
  params:
    n_estimators: 3000         # 增加迭代次数（配合降低学习率）
    max_depth: 5               # 从 6 降到 5，减少过拟合
    learning_rate: 0.01       # 从 0.03 降到 0.01，更精细搜索
    subsample: 0.8             # 从 0.9 降到 0.8，增加随机性
    colsample_bytree: 0.8      # 从 0.95 降到 0.8，特征抽样
    
    # === 新增正则化参数 ===
    reg_alpha: 0.1             # L1 正则化（稀疏化）
    reg_lambda: 1.0            # L2 正则化（平滑化）
    min_child_weight: 3        # 叶子节点最小样本权重
    gamma: 0.1                 # 分裂所需最小增益
    
    tree_method: "hist"
  
  # 早停耐心（增加到 100 轮）
  early_stopping_rounds: 100


  # === 新增：滚动训练配置 (Walk-Forward) ===
  walk_forward:
    enable: true
    start_year: 2019         # [关键] 哪一年开始产生预测？(即 2019之前的都是初始训练集)
    train_window_type: "expanding" # "expanding" (扩张: 2010~T) 或 "rolling" (滚动: T-N~T)
    rolling_window_size: 5   # 仅当 rolling 时生效，训练窗口长度(年)
    update_freq: "yearly"    # 更新频率 (目前支持按年)

  # === 新增：训练监控配置 (TensorBoard) ===
  enable_tensorboard: true   # 是否启用 TensorBoard 监控
  tensorboard:
    log_interval: 10         # 每隔多少轮记录一次（默认每轮都记录）
    log_feature_importance: true  # 是否记录特征重要性

  # === 新增：特征筛选配置 ===
  use_feature_selection: true  # 启用特征筛选（使用 selected_features.txt）


# ==============================================================================
# 5. 策略配置 (Strategy)

# ==============================================================================
strategy:
  mode: "long_topk"
  top_k: 5
  min_pred: 0.005
  recommend_top_k: 10

  # === 新增：买入价格模式 ===
  # 信号日为 T 日，买入发生在 T+1 日
  # "open":  T+1 开盘价买入（适合追涨策略）
  # "vwap":  T+1 均价买入（Volume Weighted Average Price，最接近实盘）
  # "close": T 收盘价买入（适合保守模拟）
  entry_price: "vwap"

  # === 换仓模式配置 ===
  # "rolling":  滚动换仓 (默认)。每天换 1/N 仓位，资金曲线更平滑。
  # "periodic": 定期换仓。每隔 N 天(horizon) 全部卖出换新，更符合手动操作习惯。
  rebalance_mode: "periodic"


 # 是否开启预测分平滑 (MA3)
  # true:  使用最近 3 天预测分的平均值进行排序。优点：稳健，抗噪音；缺点：信号滞后。
  # false: 仅使用当天的预测分进行排序。优点：灵敏，捕捉瞬间爆发；缺点：容易受噪音干扰。
  enable_score_smoothing: true

  # === [升级] 动态仓位管理 ===
  # 逻辑：
  # 1. 价格 > MA20: 强趋势 -> 100% 仓位
  # 2. MA60 < 价格 <= MA20: 震荡/回调 -> 50% 仓位
  # 3. 价格 <= MA60: 熊市 -> 0% 仓位 (空仓)
  position_control:
    enable: false  # 是否启用动态仓位管理
    index_code: "000300.SH"
    fast_ma: 20    # 快线
    slow_ma: 60    # 慢线
    
    # 对应的仓位比例 [强趋势, 震荡, 熊市]
    # 你可以根据风险偏好调整，比如 [0.8, 0.4, 0.0]
    ratios: [1.0, 0.5, 0.0]


# ==============================================================================
# [新增] 6. 分析与可视化配置 (Analysis)
# ==============================================================================
analysis:
  eda:
    default_sample_size: 200     # 默认随机抽样的股票数量
    random_seed: 42              # 随机种子，保证每次抽样的股票一样
    
    # 异常检测阈值
    anomaly_threshold: 0.25      # 单日涨跌幅超过 25% 视为异常 (疑似未复权)
    
    # 绘图设置
    plot:
      style: "ggplot"            # matplotlib 风格
      figure_size: [12, 6]       # 图片默认大小 [宽, 高]
      font_sans_serif:           # 优先尝试的中文字体列表
        - "SimHei"
        - "Microsoft YaHei"
        - "Arial Unicode MS"
        - "DejaVu Sans"