# 服务器自动化交易系统需求文档 v2.1

## 1. 自动化流水线 (Pipeline)

### 1.1 每日数据闭环 (15:00 - 22:00)
- **21:00 数据下载**：自动更新全市场行情。若失败，需在 22:00 前自动重试 3 次。
- **数据质检 (QC)**：调用 `clean_and_check.py`。若当日有效数据缺失率 > 5%，停止流水线并推送紧急报警。
- **特征生成与预测**：依次执行 `rebuild_features.py` 和 `run_recommendation.py`。
- **信号生成**：根据 Top-K 规则生成次日待买入清单，并在 23:00 前推送“次日观察名单”至手机端。

### 1.2 滚动训练 (策略进化)
- **触发机制**：
  1. 定期：每 90 天执行一次全量 Walk-Forward 训练。
  2. 阈值：若模型实战 IC 指标连续 10 个交易日低于 0.02，强制重启训练。
- **产物处理**：新模型自动备份至 `data/models/WF_{Date}`，系统自动切换至最新有效模型。

## 2. 交易执行逻辑 (Live Trading)

### 2.1 仓位与资金分配
- **分仓模式**：采用 Rolling 模式，将总资金平分为 N 份（N = 持有天数），每日仅操作 1/N 仓位。
- **买入策略**：
  - 资金 < 10w：11:00 前随机一次性买入。
  - 10w < 资金 < 50w：分 4 次买入（9:45, 11:00, 13:30, 14:15），每次分配 25% 仓位。
- **卖出策略**：同买入逻辑，分批平仓到期股票。

### 2.2 异常处理规则
- **涨停限制**：若推荐个股在买入时点已涨停，记录为“买入失败”，资金滚入次日可用资金。
- **跌停限制**：若持有股票在卖出时点跌停，记录为“被动锁仓”，次日优先处理。
- **Cookies 失效**：若雪球接口返回 403，立即停止所有操作并发送短信报警。

## 3. 报告与监控

### 3.1 每日交易简报 (收盘后推送)
- **基础指标**：当日买入/卖出明细、成交均价、佣金成本。
- **账户概况**：当前总净值、当日收益率、基准（沪深300）对比收益。
- **持仓分析**：各持股的持有天数、当前浮盈/浮亏、模型初始预测分。

### 3.2 运维监控
- **日志记录**：所有脚本运行日志存入 `logs/`，保留 30 天。
- **心跳检测**：脚本每小时向监控端发送一次存活信号。